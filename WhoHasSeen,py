import tableauserverclient as TSC

# Define your Tableau server connection details
TABLEAU_SERVER_URL = 'https://uat.insights.citigroup.net'
SITE_ID = 'GCT'
WORKBOOK_ID = '93cba8db-8e70-483e-a666-010117f086c6'
VIEW_ID = '30b0b00b-4bfa-4e03-bc8e-9a1da19833e0'
PAT_NAME = "API_Call" # Replace with the name you created
PAT_SECRET = "sDCBtBCCQwiD2Kg0ZvVPxQ==:7fcZtHwkz6VwQtLZ0MwwRMgaXKvkAeJ4" # Replace with the secret you saved

# Use PAT for authentication
tableau_auth = TSC.PersonalAccessTokenAuth(PAT_NAME, PAT_SECRET, site_id=SITE_ID)
server = TSC.Server(TABLEAU_SERVER_URL, use_server_version=True)
server.version = '3.1'  # Specify the API version
server.add_http_options({'verify': False})  # For UAT SSL certs

try:
    print(f"Signing in to site '{SITE_ID}' on {TABLEAU_SERVER_URL}...")
    with server.auth.sign_in(tableau_auth):
        print("Sign in successful.")

        # Log the workbook ID being used
        print(f"Attempting to retrieve workbook with ID: {WORKBOOK_ID}")

        # List all workbooks to verify the workbook ID
        # all_workbooks, pagination_item = server.workbooks.get()
        # print("List of all workbooks:")
        # for workbook in all_workbooks:
        #     print(f"Workbook ID: {workbook.id}, Name: {workbook.name}")

    
        # Get the workbook by ID
        workbook = server.workbooks.get_by_id(WORKBOOK_ID)
        print(f"Workbook found: {workbook.name}")

        # Populate the views for the workbook
        server.workbooks.populate_views(workbook)

        print("List of dashboards:")
        for view in workbook.views:
            print(f"View ID: {view.id}, Name: {view.name}, URL: {view.content_url}, Owner: {view.owner_id}")

        # Get the specific view by ID
        specific_view = server.views.get_by_id(VIEW_ID)
        print(f"Specific View - Name: {specific_view.name}, URL: {specific_view.content_url}, Owner: {specific_view.owner_id}")




except TSC.ServerResponseError as e:
    print(f"An error occurred: {e}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")
------------------------------
import tableauserverclient as TSC
import json
import csv

# ... [Keep your existing connection details here] ...

try:
    print(f"Signing in to site '{SITE_ID}' on {TABLEAU_SERVER_URL}...")
    with server.auth.sign_in(tableau_auth):
        print("Sign in successful.")

        # ... [Keep your existing workbook/view retrieval code] ...

        # Get usage statistics for the view
        actual_site_id = server.auth.site_id
        url = f"{server.baseurl}/api/{server.version}/sites/{actual_site_id}/views/{VIEW_ID}/usage"
        print(f"Requesting view usage data from: {url}")

        headers = {'Accept': 'application/json'}
        response = server._session.get(url, headers=headers)
        response.raise_for_status()
        usage_data = response.json()

        # Print raw JSON for inspection (optional)
        # print(json.dumps(usage_data, indent=2))

        # Convert to CSV
        csv_filename = 'view_usage.csv'
        with open(csv_filename, 'w', newline='', encoding='utf-8') as csvfile:
            if 'usage' in usage_data and len(usage_data['usage']) > 0:
                fieldnames = ['user_name', 'last_viewed', 'total_views']
                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                writer.writeheader()
                
                for event in usage_data['usage']:
                    user_info = event.get('user', {})
                    writer.writerow({
                        'user_name': user_info.get('name', 'Unknown'),
                        'last_viewed': event.get('lastViewedAt', ''),
                        'total_views': event.get('totalViews', 0)
                    })
                print(f"Successfully exported {len(usage_data['usage'])} records to {csv_filename}")
            else:
                print("No usage data found.")

except TSC.ServerResponseError as e:
    print(f"Tableau API error: {e}")
except Exception as e:
    print(f"General error: {e}")
--------------------------

import tableauserverclient as TSC
import csv

# Configuration
TABLEAU_SERVER_URL = 'https://uat.insights/sss.net'
SITE_ID = 'GCT'
VIEW_ID = '30b0b00b-4bfa-4e03-bc8e-9a1da19833e0'
PAT_NAME = "API_Call"
PAT_SECRET = "sXXXXXXXXXXXXXXXXXXXZ0MwXXXXXXXXXXXXXXX4"

# Set up authentication
tableau_auth = TSC.PersonalAccessTokenAuth(
    PAT_NAME,
    PAT_SECRET,
    site_id=SITE_ID
)

server = TSC.Server(TABLEAU_SERVER_URL, use_server_version=True)
server.add_http_options({'verify': False})  # Only for testing environments

try:
    print(f"Signing in to {TABLEAU_SERVER_URL}...")
    with server.auth.sign_in(tableau_auth):
        print("Authentication successful")

        # Get the view reference
        view = server.views.get_by_id(VIEW_ID)
        print(f"Accessing view: {view.name}")

        # Get view usage statistics
        usage_endpoint = f"views/{VIEW_ID}/usage"
        response = server._session.get(
            url=server.baseurl + usage_endpoint,
            headers={'Accept': 'application/json'}
        )
        response.raise_for_status()
        
        usage_data = response.json().get('usage', [])
        print(f"Found {len(usage_data)} usage records")

        # Prepare CSV output
        csv_file = 'view_usage_report.csv'
        with open(csv_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            # Write header
            writer.writerow([
                'User Name', 
                'User Email', 
                'Last Viewed', 
                'Total Views'
            ])
            
            # Write data rows
            for entry in usage_data:
                writer.writerow([
                    entry.get('user', {}).get('name', 'N/A'),
                    entry.get('user', {}).get('email', 'N/A'),
                    entry.get('lastViewedAt', 'N/A'),
                    entry.get('totalViews', 0)
                ])
        
        print(f"Successfully exported data to {csv_file}")

except TSC.ServerResponseError as e:
    print(f"Tableau API Error: {e}")
except Exception as e:
    print(f"General Error: {e}")
finally:
    if 'server' in locals() and server.auth.is_signed_in():
        server.auth.sign_out()
        print("Logged out from Tableau Server")

---------------------------------------------------
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        .tab {
            display: inline-block;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #ccc;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div>
        <div class="tab" id="prod-tab">PROD</div>
        <div class="tab" id="uat-tab">UAT</div>
    </div>
    <div id="prod-content" class="tab-content">
        <tableau-viz id='tableau-viz-prod' src='https://insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?' width='1000' height='863' toolbar='bottom'></tableau-viz>
        <button id="save-prod-data">Save PROD Data</button>
    </div>
    <div id="uat-content" class="tab-content">
        <tableau-viz id='tableau-viz-uat' src='https://uat.insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?' width='1000' height='863' toolbar='bottom'></tableau-viz>
        <button id="save-uat-data">Save UAT Data</button>
    </div>

    <script type='module' src='https://insights.citigroup.net/javascripts/api/tableau.embedding.3.latest.min.js'></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const prodTab = document.getElementById('prod-tab');
            const uatTab = document.getElementById('uat-tab');
            const prodContent = document.getElementById('prod-content');
            const uatContent = document.getElementById('uat-content');

            prodTab.addEventListener('click', function() {
                prodTab.classList.add('active');
                uatTab.classList.remove('active');
                prodContent.classList.add('active');
                uatContent.classList.remove('active');
            });

            uatTab.addEventListener('click', function() {
                uatTab.classList.add('active');
                prodTab.classList.remove('active');
                uatContent.classList.add('active');
                prodContent.classList.remove('active');
            });

            // Initialize Tableau visualizations
            const prodVizElement = document.getElementById('tableau-viz-prod');
            const prodVizUrl = prodVizElement.getAttribute('src');
            const prodViz = new tableau.Viz(prodVizElement, prodVizUrl, { hideTabs: true });

            const uatVizElement = document.getElementById('tableau-viz-uat');
            const uatVizUrl = uatVizElement.getAttribute('src');
            const uatViz = new tableau.Viz(uatVizElement, uatVizUrl, { hideTabs: true });

            // Set initial active tab
            prodTab.click();

            // Function to save data to Excel
            function saveDataToExcel(viz, fileName) {
                console.log("Saving data to Excel for:", fileName);
                const workbook = viz.getWorkbook();
                const activeSheet = workbook.getActiveSheet();
                activeSheet.getSummaryDataAsync().then(function(t) {
                    const data = t.getData();
                    const columns = t.getColumns();
                    
                    // Prepare data for Excel
                    const excelData = [];
                    const headers = columns.map(col => col.getFieldName());
                    excelData.push(headers);

                    data.forEach(row => {
                        const rowData = row.map(cell => cell.formattedValue);
                        excelData.push(rowData);
                    });

                    console.log("Excel data prepared:", excelData);

                    // Create a new workbook and add the data
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                    // Save the workbook
                    XLSX.writeFile(wb, fileName);
                    console.log("File saved:", fileName);
                }).catch(function(error) {
                    console.error("Error getting summary data:", error);
                });
            }

            // Event listeners for saving data
            document.getElementById('save-prod-data').addEventListener('click', function() {
                saveDataToExcel(prodViz, "prod_data.xlsx");
            });

            document.getElementById('save-uat-data').addEventListener('click', function() {
                saveDataToExcel(uatViz, "uat_data.xlsx");
            });
        });
    </script>
</body>
</html>

------------------------------

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        .tab {
            display: inline-block;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #ccc;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        tableau-viz {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div>
        <div class="tab active" id="prod-tab">PROD</div>
        <div class="tab" id="uat-tab">UAT</div>
    </div>
    <div id="prod-content" class="tab-content active">
        <tableau-viz id='tableau-viz-prod' src='https://insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?' toolbar='bottom'></tableau-viz>
        <button id="save-prod-data">Save PROD Data</button>
    </div>
    <div id="uat-content" class="tab-content">
        <tableau-viz id='tableau-viz-uat' src='https://uat.insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?' toolbar='bottom'></tableau-viz>
        <button id="save-uat-data">Save UAT Data</button>
    </div>

    <script type='module'>
        import { Workbook } from 'https://insights.citigroup.net/javascripts/api/tableau.embedding.3.latest.min.js';

        document.addEventListener("DOMContentLoaded", async () => {
            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to selected tab and content
                    tab.classList.add('active');
                    const contentId = tab.id.replace('-tab', '-content');
                    document.getElementById(contentId).classList.add('active');
                });
            });

            // Initialize workbooks
            let prodWorkbook, uatWorkbook;

            // Initialize PROD viz
            const prodViz = document.getElementById('tableau-viz-prod');
            prodViz.addEventListener('load', async (event) => {
                prodWorkbook = event.detail.viz.workbook;
                console.log('PROD Workbook loaded');
            });

            // Initialize UAT viz
            const uatViz = document.getElementById('tableau-viz-uat');
            uatViz.addEventListener('load', async (event) => {
                uatWorkbook = event.detail.viz.workbook;
                console.log('UAT Workbook loaded');
            });

            // Excel export function
            async function exportToExcel(workbook, fileName) {
                try {
                    const activeSheet = workbook.activeSheet;
                    if (activeSheet.sheetType === 'WORKSHEET') {
                        const dataTable = await activeSheet.getUnderlyingDataAsync();
                        const columns = dataTable.columns.map(col => col.fieldName);
                        const data = dataTable.data.map(row => 
                            row.map(cell => cell.formattedValue)
                        );

                        // Create worksheet
                        const ws = XLSX.utils.aoa_to_sheet([columns, ...data]);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                        XLSX.writeFile(wb, fileName);
                    } else {
                        alert('Please select a worksheet to export data');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Error exporting data: ' + error.message);
                }
            }

            // Event listeners for export buttons
            document.getElementById('save-prod-data').addEventListener('click', () => {
                if (prodWorkbook) exportToExcel(prodWorkbook, 'PROD_Data.xlsx');
                else alert('PROD workbook not loaded yet');
            });

            document.getElementById('save-uat-data').addEventListener('click', () => {
                if (uatWorkbook) exportToExcel(uatWorkbook, 'UAT_Data.xlsx');
                else alert('UAT workbook not loaded yet');
            });
        });
    </script>
</body>
</html>
---------------------------

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Visualization Download</title>
    <!-- No need for xlsx.js if using the API's export function -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script> -->
    <style>
        body { font-family: sans-serif; }
        .tab {
            display: inline-block;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-bottom: none; /* For better tab look */
            margin-right: 5px;
            border-radius: 5px 5px 0 0; /* Rounded top corners */
        }
        .tab.active {
            background-color: #fff; /* Active tab matches background */
            border-bottom: 1px solid #fff; /* Hide bottom border */
            font-weight: bold;
        }
        .tab-content {
            display: none;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 0 5px 5px 5px; /* Rounded corners except top-left */
        }
        .tab-content.active {
            display: block;
        }
        button {
            padding: 8px 15px;
            margin-top: 15px;
            cursor: pointer;
        }
        /* Optional: Style to indicate button is disabled */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <h1>Tableau Data Export</h1>

    <div>
        <div class="tab active" id="prod-tab" data-target="prod-content" data-viz-id="tableau-viz-prod">PROD</div>
        <div class="tab" id="uat-tab" data-target="uat-content" data-viz-id="tableau-viz-uat">UAT</div>
    </div>

    <div id="prod-content" class="tab-content active">
        <h2>PROD Environment</h2>
        <p>Loading PROD Visualization...</p>
        <!-- Ensure unique IDs if you might have more embeds later -->
        <tableau-viz
            id='tableau-viz-prod'
            src='https://insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?'
            width='1000' height='863'
            toolbar='bottom'
            hide-tabs>
        </tableau-viz>
        <button id="save-prod-data" disabled>Export PROD View to Excel</button>
    </div>

    <div id="uat-content" class="tab-content">
        <h2>UAT Environment</h2>
        <p>Loading UAT Visualization...</p>
        <tableau-viz
            id='tableau-viz-uat'
            src='https://uat.insights.citigroup.net/vizql/showadminview/views/WhoHasSeen?'
            width='1000' height='863'
            toolbar='bottom'
            hide-tabs>
        </tableau-viz>
        <button id="save-uat-data" disabled>Export UAT View to Excel</button>
    </div>

    <!-- Load Tableau Embedding API v3 -->
    <script type='module' src='https://insights.citigroup.net/javascripts/api/tableau.embedding.3.latest.min.js'></script>

    <script type="module">
        // Get references to elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const prodVizEl = document.getElementById('tableau-viz-prod');
        const uatVizEl = document.getElementById('tableau-viz-uat');
        const prodButton = document.getElementById('save-prod-data');
        const uatButton = document.getElementById('save-uat-data');

        // --- Tab Switching Logic ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Deactivate all tabs and content
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Activate clicked tab and corresponding content
                tab.classList.add('active');
                const targetContentId = tab.getAttribute('data-target');
                document.getElementById(targetContentId).classList.add('active');

                // Optional: Re-enable the button for the now active viz,
                // but it's better to rely on the 'firstinteractive' event
                // const vizId = tab.getAttribute('data-viz-id');
                // const vizEl = document.getElementById(vizId);
                // const button = document.querySelector(`[data-viz-id="${vizId}"] ~ button`);
                // if (vizEl && vizEl.viz && button) { // Check if viz object exists
                //     button.disabled = false;
                // }
            });
        });

        // --- Tableau Viz Initialization and Export Logic ---

        // Function to handle the export action
        async function exportVizDataToExcel(vizElement, buttonElement) {
            if (!vizElement || !vizElement.viz) {
                console.error("Viz object not found for element:", vizElement.id);
                alert("Error: Visualization is not ready. Please wait and try again.");
                return;
            }

            console.log(`Attempting to export data for viz: ${vizElement.id}`);
            buttonElement.textContent = 'Exporting...'; // Provide user feedback
            buttonElement.disabled = true;

            try {
                // Use the API's built-in function to export the current sheet's crosstab data
                await vizElement.viz.exportCrossTabToExcelAsync();
                console.log(`Export successful for viz: ${vizElement.id}`);
                alert(`Data for ${vizElement.id} exported successfully! Check your browser downloads.`);
            } catch (error) {
                console.error(`Error exporting data for viz ${vizElement.id}:`, error);
                alert(`Error exporting data for ${vizElement.id}. See console for details.`);
            } finally {
                 // Reset button state regardless of success/failure
                 buttonElement.textContent = `Export ${vizElement.id.includes('prod') ? 'PROD' : 'UAT'} View to Excel`;
                 buttonElement.disabled = false;
            }
        }

        // --- Event Listeners for Viz Loading and Button Clicks ---

        // Wait for the PROD viz to be interactive, then enable its button
        prodVizEl.addEventListener('firstinteractive', (event) => {
            console.log("PROD Viz is interactive:", event.detail);
            // Remove the "Loading..." message
            const loadingMessage = prodVizEl.previousElementSibling;
             if (loadingMessage && loadingMessage.tagName === 'P') {
                 loadingMessage.style.display = 'none';
            }
            prodButton.disabled = false; // Enable the button
            // The viz object is now available at prodVizEl.viz
        });

        // Wait for the UAT viz to be interactive, then enable its button
        uatVizEl.addEventListener('firstinteractive', (event) => {
            console.log("UAT Viz is interactive:", event.detail);
             // Remove the "Loading..." message
             const loadingMessage = uatVizEl.previousElementSibling;
             if (loadingMessage && loadingMessage.tagName === 'P') {
                 loadingMessage.style.display = 'none';
            }
            uatButton.disabled = false; // Enable the button
            // The viz object is now available at uatVizEl.viz
        });

        // Add click listener for the PROD export button
        prodButton.addEventListener('click', () => {
            exportVizDataToExcel(prodVizEl, prodButton);
        });

        // Add click listener for the UAT export button
        uatButton.addEventListener('click', () => {
            exportVizDataToExcel(uatVizEl, uatButton);
        });

        // --- Initial State ---
        // No need to manually call click, the HTML sets the initial active tab.

    </script>
</body>
</html>
